 <h1><a name="Introduction"></a>Introduction<a href="#Introduction" class="section_anchor"></a></h1><p>Arduino library for communicating with KlikAanKlikUit (KaKu) devices using a 433Mhz tranceiver or with separate receiver and transmitter modules </p><p>The library works asynchronously using the Timer1 interrupt running at a 175us period. </p><p>There are separate receive and transmit buffers. </p><p>both the old type modules as the new type modules (automatic code) are supported </p><p>For these new type modules, the group and set dim level commands are also supported </p><p>Frames being sent are autmaically repeated five times (configurable) Received frame are filtered for duplicates. (unless they arrive more than ~10 seconds apart) </p><h1><a name="Details"></a>Details<a href="#Details" class="section_anchor"></a></h1><p>Main library functions: </p><ul><li><tt>kk_init()</tt> initialize the library, starts the timer interrupt </li><li><tt>kk_available()</tt> Check if there is anything in the receive buffer </li><li><tt>kk_receive(&amp;address,&amp;unit,&amp;cmd,&amp;dimlevel)</tt> Get a frame from the receive buffer.  </li><li><tt>kk_send(address,unit,cmd,dimlevel)</tt> Put a frame in the send buffer </li></ul><p></p><p>example Arduino sketch: </p><pre class="prettyprint"><span class="com">#include</span><span class="pln"> </span><span class="str">&lt;kk.h&gt;</span><span class="pln"><br><br></span><span class="kwd">void</span><span class="pln"> setup</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; </span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">begin</span><span class="pun">(</span><span class="lit">9600</span><span class="pun">);</span><span class="pln"><br>&nbsp; kk_init</span><span class="pun">();</span><span class="pln"><br></span><span class="pun">}</span><span class="pln"><br><br></span><span class="kwd">char</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> parse</span><span class="pun">(</span><span class="kwd">char</span><span class="pln"> </span><span class="pun">**</span><span class="pln">s</span><span class="pun">)</span><span class="pln"><br>&nbsp; </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="kwd">char</span><span class="pln"> </span><span class="pun">*</span><span class="pln">p </span><span class="pun">=</span><span class="pln"> </span><span class="pun">*</span><span class="pln">s</span><span class="pun">;</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="kwd">char</span><span class="pln"> </span><span class="pun">*</span><span class="pln">q</span><span class="pun">;</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="kwd">while</span><span class="pln"> </span><span class="pun">(*</span><span class="pln">p</span><span class="pun">==</span><span class="str">' '</span><span class="pun">)</span><span class="pln"> p</span><span class="pun">++;</span><span class="pln"><br>&nbsp; &nbsp; q </span><span class="pun">=</span><span class="pln"> p</span><span class="pun">;</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="kwd">while</span><span class="pln"> </span><span class="pun">((*</span><span class="pln">p</span><span class="pun">!=</span><span class="str">' '</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> </span><span class="pun">(*</span><span class="pln">p</span><span class="pun">!=</span><span class="lit">0</span><span class="pun">))</span><span class="pln"> p</span><span class="pun">++;</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(*</span><span class="pln">p</span><span class="pun">==</span><span class="str">' '</span><span class="pun">)</span><span class="pln"> </span><span class="pun">*</span><span class="pln">p</span><span class="pun">++</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="pun">*</span><span class="pln">s </span><span class="pun">=</span><span class="pln"> p</span><span class="pun">;</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="kwd">return</span><span class="pln"> q</span><span class="pun">;</span><span class="pln"><br>&nbsp; </span><span class="pun">}</span><span class="pln"> &nbsp;<br>&nbsp; <br></span><span class="kwd">void</span><span class="pln"> loop</span><span class="pun">()</span><span class="pln"> <br></span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp;</span><span class="kwd">unsigned</span><span class="pln"> </span><span class="kwd">long</span><span class="pln"> address</span><span class="pun">;</span><span class="pln"><br>&nbsp; &nbsp;</span><span class="kwd">unsigned</span><span class="pln"> </span><span class="kwd">char</span><span class="pln"> unit</span><span class="pun">,</span><span class="pln">dimlevel</span><span class="pun">,</span><span class="pln">onoff</span><span class="pun">;</span><span class="pln"><br>&nbsp; &nbsp;</span><span class="kwd">static</span><span class="pln"> </span><span class="kwd">char</span><span class="pln"> inbuf</span><span class="pun">[</span><span class="lit">20</span><span class="pun">];</span><span class="pln"><br>&nbsp; &nbsp;</span><span class="kwd">static</span><span class="pln"> </span><span class="kwd">unsigned</span><span class="pln"> </span><span class="kwd">char</span><span class="pln"> i</span><span class="pun">=</span><span class="lit">0</span><span class="pun">;</span><span class="pln"><br>&nbsp; &nbsp;</span><span class="kwd">char</span><span class="pln"> </span><span class="pun">*</span><span class="pln">p</span><span class="pun">,*</span><span class="pln">s</span><span class="pun">,</span><span class="pln">c</span><span class="pun">;</span><span class="pln"><br>&nbsp; &nbsp;</span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">kk_available</span><span class="pun">())</span><span class="pln"><br>&nbsp; &nbsp; &nbsp;</span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;kk_receive</span><span class="pun">(&amp;</span><span class="pln">address</span><span class="pun">,&amp;</span><span class="pln">unit</span><span class="pun">,&amp;</span><span class="pln">onoff</span><span class="pun">,&amp;</span><span class="pln">dimlevel</span><span class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"A: "</span><span class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="pln">address</span><span class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"U: "</span><span class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="pln">unit</span><span class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"C: "</span><span class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">((</span><span class="pln">onoff</span><span class="pun">==</span><span class="lit">0</span><span class="pun">)?</span><span class="str">"Off"</span><span class="pun">:(</span><span class="pln">onoff</span><span class="pun">==</span><span class="lit">1</span><span class="pun">)?</span><span class="str">"On "</span><span class="pun">:</span><span class="str">"Dim"</span><span class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"D: "</span><span class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="pln">dimlevel</span><span class="pun">);</span><span class="pln"> &nbsp; &nbsp; &nbsp; &nbsp;<br>&nbsp; &nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br>&nbsp; &nbsp;</span><span class="kwd">if</span><span class="pln"> &nbsp;</span><span class="pun">(</span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">available</span><span class="pun">())</span><span class="pln"><br>&nbsp; &nbsp; &nbsp;</span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp;c </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">read</span><span class="pun">();</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">c</span><span class="pun">==</span><span class="str">'\n'</span><span class="pun">)</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;inbuf</span><span class="pun">[</span><span class="pln">i</span><span class="pun">++]=</span><span class="lit">0</span><span class="pun">;</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;i</span><span class="pun">=</span><span class="lit">0</span><span class="pun">;</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="pln">inbuf</span><span class="pun">);</span><span class="pln"> &nbsp; &nbsp; &nbsp; &nbsp;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;p</span><span class="pun">=</span><span class="pln">inbuf</span><span class="pun">;</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">strlen</span><span class="pun">(</span><span class="pln">p</span><span class="pun">)&gt;</span><span class="lit">5</span><span class="pun">)</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;s</span><span class="pun">=</span><span class="pln">parse</span><span class="pun">(&amp;</span><span class="pln">p</span><span class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;address</span><span class="pun">=</span><span class="pln">atol</span><span class="pun">(</span><span class="pln">s</span><span class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;s</span><span class="pun">=</span><span class="pln">parse</span><span class="pun">(&amp;</span><span class="pln">p</span><span class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;unit</span><span class="pun">=</span><span class="pln">atoi</span><span class="pun">(</span><span class="pln">s</span><span class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;s</span><span class="pun">=</span><span class="pln">parse</span><span class="pun">(&amp;</span><span class="pln">p</span><span class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;onoff</span><span class="pun">=</span><span class="lit">0</span><span class="pun">;</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln"> &nbsp; &nbsp; strcmp</span><span class="pun">(</span><span class="pln">s</span><span class="pun">,</span><span class="str">"off"</span><span class="pun">)==</span><span class="lit">0</span><span class="pun">)</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;onoff</span><span class="pun">=</span><span class="lit">0</span><span class="pun">;</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="kwd">else</span><span class="pln"> </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">strcmp</span><span class="pun">(</span><span class="pln">s</span><span class="pun">,</span><span class="str">"on"</span><span class="pun">)</span><span class="pln"> </span><span class="pun">==</span><span class="lit">0</span><span class="pun">)</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;onoff</span><span class="pun">=</span><span class="lit">1</span><span class="pun">;</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="kwd">else</span><span class="pln"> </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">strcmp</span><span class="pun">(</span><span class="pln">s</span><span class="pun">,</span><span class="str">"dim"</span><span class="pun">)==</span><span class="lit">0</span><span class="pun">)</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;onoff</span><span class="pun">=</span><span class="lit">2</span><span class="pun">;</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">onoff</span><span class="pun">==</span><span class="lit">2</span><span class="pun">)</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;s</span><span class="pun">=</span><span class="pln">parse</span><span class="pun">(&amp;</span><span class="pln">p</span><span class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dimlevel</span><span class="pun">=</span><span class="pln">atoi</span><span class="pun">(</span><span class="pln">s</span><span class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="pun">}</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="kwd">else</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dimlevel</span><span class="pun">=</span><span class="lit">0</span><span class="pun">;</span><span class="pln"> &nbsp;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"a: "</span><span class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="pln">address</span><span class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"u: "</span><span class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="pln">unit</span><span class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"c: "</span><span class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">((</span><span class="pln">onoff</span><span class="pun">==</span><span class="lit">0</span><span class="pun">)?</span><span class="str">"Off"</span><span class="pun">:(</span><span class="pln">onoff</span><span class="pun">==</span><span class="lit">1</span><span class="pun">)?</span><span class="str">"On "</span><span class="pun">:</span><span class="str">"Dim"</span><span class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="typ">Serial</span><span class="pun">.</span><span class="kwd">print</span><span class="pun">(</span><span class="str">"d: "</span><span class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="typ">Serial</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="pln">dimlevel</span><span class="pun">);</span><span class="pln"> &nbsp; &nbsp; &nbsp; &nbsp;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;kk_send</span><span class="pun">(</span><span class="pln">address</span><span class="pun">,</span><span class="pln">unit</span><span class="pun">,</span><span class="pln">onoff</span><span class="pun">,</span><span class="pln">dimlevel</span><span class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="pun">}</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="pun">}</span><span class="pln"> <br>&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="kwd">if</span><span class="pln"> </span><span class="pun">((</span><span class="pln">i</span><span class="pun">&lt;</span><span class="lit">19</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> </span><span class="pun">(</span><span class="pln">c</span><span class="pun">!=</span><span class="lit">13</span><span class="pun">))</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;inbuf</span><span class="pun">[</span><span class="pln">i</span><span class="pun">++]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> c</span><span class="pun">;</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="pun">}</span><span class="pln"><br>&nbsp; &nbsp; &nbsp;</span><span class="pun">}</span><span class="pln"> &nbsp;<br></span><span class="pun">}</span></pre>